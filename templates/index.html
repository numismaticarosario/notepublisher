<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>NOTE PUBLISHER</title>
  <style>
    body { margin: 0; background: #f0f2f5; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    h1 { font-size: 2rem; color: #0d6efd; margin: 20px 0 40px 0; text-align: center; }
    .layout { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; width: 100%; max-width: 1400px; margin-top: 20px; gap: 20px; }
    .left-panel { display: flex; flex-direction: column; align-items: center; }
    .dropzone { width: 100%; max-width: 320px; height: 100px; border: 2px dashed #cbd5e1; border-radius: 15px; background: #fff; display: flex; justify-content: center; align-items: center; color: #555; font-size: 1rem; text-align: center; margin-bottom: 20px; }
    .dropzone.hover { border-color: #0d6efd; background: #e7f1ff; }
    #placeholder { user-select: none; }
    .action-btn { padding: 10px 20px; font-size: 1rem; border-radius: 10px; border: none; background: #0d6efd; color: white; cursor: not-allowed; margin-top: 10px; height: 42px; }
    .data-panel { display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
    .field { display: flex; align-items: center; gap: 6px; }
    .field label { font-weight: bold; min-width: 110px; text-align: right; }
    .field input { flex: 1; height: 26px; border-radius: 6px; border: 1px solid #bbb; padding: 4px 8px; font-size: 0.85rem; background: #d3d3d3; color: #555; }
    .field input:enabled { background: #fff; color: #000; }
    .process-btn-row { display: flex; align-items: center; gap: 6px; margin-top: 20px; }
    .process-btn-row label { min-width: 110px; }
    .process-btn-row button { flex: 1; height: 42px; border-radius: 10px; border: none; background: #0d6efd; color: white; font-size: 0.95rem; cursor: not-allowed; }
    .right-panel { grid-column: 3 / span 2; display: flex; flex-direction: column; gap: 12px; align-items: flex-start; } 
    .extended-field { display: flex; align-items: flex-start; gap: 6px; width: 100%; }
    .extended-field label { font-weight: bold; min-width: 110px; text-align: right; padding-top: 6px; }
    .extended-field input, .extended-field textarea { flex: 1; border-radius: 6px; border: 1px solid #bbb; padding: 6px 8px; font-size: 0.85rem; background: #d3d3d3; color: #555; }
    .extended-field input:enabled, .extended-field textarea:enabled { background: #fff; color: #000; }
    #titulo { height: 26px; }
    #descripcion { height: 280px; resize: none; overflow: hidden; }

    .excel-btn-container { 
      display: flex; 
      justify-content: center; 
      width: calc(100% - 110px);
      margin-top: 10px; 
      margin-left: 110px; 
    }
    #excelBtn { padding: 10px 20px; font-size: 1rem; border-radius: 10px; border: none; background: #0d6efd; color: white; cursor: not-allowed; height: 42px; }
  </style>
</head>
<body>
  <h1>NOTE PUBLISHER - NR</h1>
  <div class="layout">
    <div class="left-panel">
      <div id="dropzone" class="dropzone">
        <span id="placeholder">Arrastrar Captura Aquí</span>
        <span id="filename" style="display:none; font-weight:bold;"></span>
      </div>
      <button id="getDataBtn" class="action-btn" disabled>Obtener Datos</button>
    </div>
    <div class="data-panel">
      <div class="field"><label>Pais:</label><input type="text" disabled></div>
      <div class="field"><label>Valor:</label><input type="text" disabled></div>
      <div class="field"><label>P / Bot. / N:</label><input type="text" disabled></div>
      <div class="field"><label>Material:</label><input type="text" disabled></div>
      <div class="field"><label>Tamaño:</label><input type="text" disabled></div>
      <div class="field"><label>Fecha:</label><input type="text" disabled></div>
      <div class="field"><label>Conservacion:</label><input type="text" disabled></div>
      <div class="field"><label>Fisher:</label><input type="text" disabled></div>
      <div class="field"><label>Diseño:</label><input type="text" disabled></div>
      <div class="field"><label>Precio:</label><input type="text" disabled></div>
      <div class="process-btn-row">
        <label></label>
        <button id="processBtn" disabled>Procesar Info</button>
      </div>
    </div>
    <div class="right-panel">
      <div class="extended-field"><label>Título:</label><input type="text" id="titulo" disabled></div>
      <div class="extended-field"><label>Descripción:</label><textarea id="descripcion" disabled></textarea></div>

      <div class="excel-btn-container">
        <button id="excelBtn" disabled>Generar Excel</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const placeholder = document.getElementById("placeholder");
    const filenameSpan = document.getElementById("filename");
    const getDataBtn = document.getElementById("getDataBtn");
    const processBtn = document.getElementById("processBtn");
    const dropzone = document.getElementById("dropzone");
    const titulo = document.getElementById("titulo");
    const descripcion = document.getElementById("descripcion");
    const excelBtn = document.getElementById("excelBtn");
    let currentFile = null;

    function checkEnableProcessBtn() {
      const inputs = document.querySelectorAll(".data-panel input");
      const allEnabled = Array.from(inputs).every(input => !input.disabled);
      processBtn.disabled = !allEnabled;
      processBtn.style.cursor = allEnabled ? "pointer" : "not-allowed";
    }

    function checkEnableExcelBtn() {
      if (!titulo.disabled && titulo.value.trim() !== "" &&
          !descripcion.disabled && descripcion.value.trim() !== "") {
        excelBtn.disabled = false;
        excelBtn.style.cursor = "pointer";
      }
    }

    ["dragenter","dragover"].forEach(e => dropzone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); dropzone.classList.add("hover"); }));
    ["dragleave","drop"].forEach(e => dropzone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); dropzone.classList.remove("hover"); }));

    dropzone.addEventListener("drop", e => {
      const file = e.dataTransfer.files?.[0];
      if(file){
        currentFile = file;
        placeholder.style.display = "none";
        filenameSpan.textContent = file.name;
        filenameSpan.style.display = "inline";
        getDataBtn.disabled = false;
        getDataBtn.style.cursor = "pointer";
      }
    });

    document.addEventListener("paste", e => {
      const items = e.clipboardData?.items || [];
      for(const item of items){
        if(item.type.startsWith("image/")){
          const blob = item.getAsFile();
          if(blob){
            currentFile = new File([blob], "captura.png", { type: blob.type });
            placeholder.style.display = "none";
            filenameSpan.textContent = "captura.png";
            filenameSpan.style.display = "inline";
            getDataBtn.disabled = false;
            getDataBtn.style.cursor = "pointer";
            break;
          }
        }
      }
    });

    getDataBtn.addEventListener("click", async () => {
      if(!currentFile) return;
      const formData = new FormData();
      formData.append("image", currentFile);
      try {
        const res = await fetch("/extract", { method: "POST", body: formData });
        const data = await res.json();
        const inputs = document.querySelectorAll(".data-panel input");
        const keys = ["pais","valor","referencia","metal","diametro","fecha","conservacion","fisher","diseno","precio"];
        inputs.forEach((input, i) => {
          input.disabled = false;
          if(data[keys[i]]) input.value = data[keys[i]];
        });
        checkEnableProcessBtn();
      } catch(err) {
        console.error("Error al obtener datos:", err);
      }
    });

    processBtn.addEventListener("click", () => {
      const inputs = document.querySelectorAll(".data-panel input");
      const getVal = (name) => {
        const keys = ["pais","valor","referencia","metal","diametro","fecha","conservacion","fisher","diseno","precio"];
        return inputs[keys.indexOf(name)].value.trim();
      };

      let tituloText = `${getVal("pais")} - ${getVal("valor")} - Año ${getVal("fecha")} - ${getVal("referencia")}`;
if(getVal("fisher")) tituloText += ` - ${getVal("fisher")}`;


      titulo.disabled = false;
      titulo.value = tituloText;

      const consMap = {
        "P": "pobre",
        "F -": "bueno -",
        "F": "bueno",
        "F +": "bueno +",
        "VF -": "muy bueno -",
        "VF": "muy bueno",
        "VF +": "muy bueno +",
        "XF -": "excelente -",
        "XF": "excelente",
        "XF +": "excelente +",
        "Unc -": "nuevo sin uso -",
        "Unc": "nuevo sin uso",
        "Proof": ""
      };

      let consVal = getVal("conservacion");
      let consText = consMap[consVal] ? ` (${consMap[consVal]})` : "";

      let desc = `Billete impreso en ${getVal("metal")} de ${getVal("pais").toUpperCase()} de ${getVal("valor").toUpperCase()} del año ${getVal("fecha")}. Conservación: ${consVal}${consText}. Catalogación: ${getVal("referencia")}. Tamaño: ${getVal("diametro")}. Diseño: ${getVal("diseno")}.\n\n`;

      const priceMap = { "0":"O","1":"M","2":"U","3":"R","4":"C","5":"I","6":"E","7":"L","8":"A","9":"G", ",":"-", ".":"-" };
      let precio = getVal("precio").split("").map(ch => priceMap[ch] || ch).join("");
      desc += `CODIGO: ${precio}`;

      descripcion.disabled = false;
      descripcion.value = desc;

      checkEnableExcelBtn();
    });

    excelBtn.addEventListener("click", () => {
      const inputs = document.querySelectorAll(".data-panel input");
      const getVal = (name) => {
        const keys = ["pais","valor","referencia","metal","diametro","fecha","conservacion","fisher","diseno","precio"];
        return inputs[keys.indexOf(name)].value.trim();
      };

      const tituloVal = titulo.value.trim();
      const descVal = descripcion.value.trim();
      const consVal = getVal("conservacion");
      const precioVal = parseFloat(getVal("precio")) || 0;
      const paisVal = getVal("pais");
      const valorVal = getVal("valor");
      const fechaVal = getVal("fecha");
      const metalVal = getVal("metal");

      const estado = consVal === "Unc" ? "Nuevo" : "Usado";
      let calcPrecio = ((precioVal * 1500) / 0.84) + 1000;
      calcPrecio = Math.ceil(calcPrecio / 100) * 100;

      const row = [
        "", tituloVal, "", estado, "", 
        "https://http2.mlstatic.com/D_NQ_NP_697806-MLA88371869892_072025-F.jpg",
        "", 1, calcPrecio, "", 1,
        descVal, "", "No agregar cuotas", "", "Mercado Envíos",
        "A cargo del comprador", "Acepto", "Garantía del vendedor",
        7, "días", "", paisVal, valorVal, "", fechaVal, "",  // AB
      ];

      const ws = XLSX.utils.aoa_to_sheet([row]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Datos");
      XLSX.writeFile(wb, "coin_data.xlsx");
    });
  </script>
</body>
</html>
<script>
  const dropzone = document.getElementById('dropzone');
  const placeholder = document.getElementById('placeholder');
  const filenameSpan = document.getElementById('filename');
  const getDataBtn = document.getElementById('getDataBtn');
  let uploadedFile = null;

  // Función para mostrar la imagen copiada o arrastrada
  function setImageFile(file) {
    uploadedFile = file;
    if (uploadedFile) {
      placeholder.style.display = 'none';
      filenameSpan.style.display = 'inline';
      filenameSpan.textContent = uploadedFile.name;
      getDataBtn.disabled = false;
      getDataBtn.style.cursor = 'pointer';
    }
  }

  // Drag & Drop
  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('hover');
  });

  dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('hover');
  });

  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('hover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image')) {
      setImageFile(file);
    } else {
      alert('Por favor, arrastra solo imágenes.');
    }
  });

  // Pegar desde portapapeles
  dropzone.addEventListener('paste', (e) => {
    const items = e.clipboardData && e.clipboardData.items;
    if (!items) return;
    for (let item of items) {
      if (item.type.startsWith('image')) {
        const blob = item.getAsFile();
        if (blob) {
          const file = new File([blob], 'pasted-image.png', { type: blob.type });
          setImageFile(file);
        }
        break; // Solo manejar la primera imagen copiada
      }
    }
  });

  // Botón para extraer datos con OCR
  document.getElementById('getDataBtn').addEventListener('click', async () => {
    if (!uploadedFile) return;
    const reader = new FileReader();
    reader.onload = async () => {
      const { data: { text } } = await Tesseract.recognize(
        reader.result,
        'spa'
      );
      const regex = /351\s*-\s*Contribuciones\s+de\s+Seguridad\s+Social\s+([\d.,]+)/i;
      const match = text.match(regex);
      if (match) {
        document.getElementById('conSS').value = match[1];
      } else {
        alert("No se encontró el valor de '351 - Contribuciones de Seguridad Social'");
      }
    };
    reader.readAsDataURL(uploadedFile);
  });
</script>



